<!-- backend/templates/stats.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üìä HR Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 28px;
            font-family: 'Segoe UI', sans-serif;
            background: url("{{ url_for('static', filename='assets/img/Dkyellow domain.png') }}") no-repeat center center fixed;
            background-size: cover;
        }
        h1 {
            text-align: left;
            margin-bottom: 18px;
            font-size: 1.9rem;
            font-weight: 700;
            color: #2b7bad; /* Blue from theme */
            display: inline-block;
        }
        .controls {
            float: right;
            margin-top: -6px;
        }
        .download-btn {
            background-color: #dc3545; /* Yellow/Orange from theme */
            color: white;
            border: none;
        }
        .download-btn:hover { filter: brightness(0.95); }
        .nav-tabs .nav-link { font-weight: 500; color: #495057; }
        .nav-tabs .nav-link.active {
            background-color: #2b7bad; /* Blue */
            color: white;
            border-color: #2b7bad #2b7bad #fff;
        }
        .section-card {
            padding: 18px;
            background: rgba(255, 255, 255, 0.88); /* translucent white for readability */
            border-radius: 12px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.06);
            margin-top: 18px;
        }
        table { border-radius: 8px; overflow: hidden; background: white; }
        th {
            background: #70b55f; /* Green from theme */
            color: white;
            text-transform: capitalize;
            text-align: center;
            font-size: 0.92rem;
        }
        td { text-align: center; font-size: 0.9rem; vertical-align: middle; }
        .highlight-high {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: 600;
        }
        .highlight-low {
            background-color: #f8d7da !important;
            color: #721c24;
            font-weight: 600;
        }
        .badge-custom { padding: 0.4em 0.65em; border-radius: 8px; font-size: 0.85rem; font-weight: 500; }
        .badge-high { background-color: #70b55f; color: white; } /* Green */
        .badge-medium { background-color: #ffde85; color: #212529; } /* Light Yellow */
        .badge-low { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
<div class="container-fluid px-3">

    <div class="d-flex align-items-center mb-2">
        <h1>üìà HR Analytics Dashboard</h1>

        <div class="controls ms-auto">
            <button class="btn btn-outline-secondary me-2" onclick="window.print()" title="Quick print">
                üñ® Print View
            </button>
            <!-- Download report button opens modal -->
            <button class="btn download-btn" data-bs-toggle="modal" data-bs-target="#downloadModal">
                ‚¨áÔ∏è Download Report
            </button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="analyticsTabs" role="tablist">
        {% for section, rows in stats.items() %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}"
                        id="{{ section }}-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#{{ section }}-content"
                        type="button" role="tab"
                        aria-controls="{{ section }}-content"
                        aria-selected="{{ 'true' if loop.first else 'false' }}">
                    {% if section == 'salary_comparison' %}
                        üíµ Salary Comparison
                    {% else %}
                        {{ section.replace('_', ' ').title() }}
                    {% endif %}
                </button>
            </li>
        {% endfor %}
    </ul>

    <!-- Tab Contents -->
    <div class="tab-content" id="analyticsTabsContent">
        {% for section, rows in stats.items() %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ section }}-content" role="tabpanel">
                <div class="section-card">
                    <h5 class="mb-3" style="color:#2b7bad; font-weight:700;">
                        {{ section.replace('_', ' ').title() }}
                    </h5>

                    {% if rows %}
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle">
                                <thead>
                                    <tr>
                                        {% for col in rows[0]._mapping.keys() %}
                                            <th>{{ col.replace('_', ' ').title() }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in rows %}
                                        <tr>
                                            {% for col, value in row._mapping.items() %}
                                                <td
                                                    {% if col == 'current_salary' and value is number and value > 70000 %}
                                                        class="highlight-high"
                                                    {% elif col == 'current_salary' and value is number and value < 40000 %}
                                                        class="highlight-low"
                                                    {% endif %}
                                                >
                                                    {% if col == 'grade' %}
                                                        <span class="badge-custom 
                                                            {% if value == 'High' %}badge-high
                                                            {% elif value == 'Medium' %}badge-medium
                                                            {% else %}badge-low{% endif %}">
                                                            {{ value }}
                                                        </span>
                                                    {% else %}
                                                        {{ value }}
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted fst-italic">No data available for this section.</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Download Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <form id="downloadForm">
        <div class="modal-header">
          <h5 class="modal-title" id="downloadModalLabel">Download Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted">Enter company details to include in the report header (optional).</p>
          <div class="mb-3">
            <label for="companyName" class="form-label">Company / Organization Name</label>
            <input type="text" class="form-control" id="companyName" name="company_name" placeholder="Acme Corp">
          </div>
          <div class="mb-3">
            <label for="companyDetails" class="form-label">Company Details / Notes</label>
            <textarea class="form-control" id="companyDetails" name="company_details" rows="3" placeholder="Address, contact, tiny note..."></textarea>
          </div>
          <div class="form-text">The generated PDF will include a report header, the download timestamp and all analytics sections.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">‚¨áÔ∏è Generate & Download PDF</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS and download logic -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('downloadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    const formData = new FormData(e.target);
    try {
        const resp = await fetch('{{ url_for("analytics.download_report") }}', {
            method: 'POST',
            body: formData,
        });

        if (!resp.ok) {
            const txt = await resp.text();
            alert('Failed to generate PDF: ' + txt);
            btn.disabled = false;
            btn.textContent = '‚¨áÔ∏è Generate & Download PDF';
            return;
        }

        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');

        // filename from Content-Disposition, fallback to default
        const cd = resp.headers.get('Content-Disposition') || '';
        let filename = 'HRMS_Report.pdf';
        const m = cd.match(/filename="(.+)"/);
        if (m && m[1]) filename = m[1];

        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        // close modal
        const modalEl = document.getElementById('downloadModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    } catch (err) {
        console.error(err);
        alert('Error generating PDF: ' + err);
    } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Generate & Download PDF';
    }
});
</script>
</body>
</html>
