<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MongoDB Personnel Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg,#f4f8fb,#eef6f2); font-family: "Segoe UI", sans-serif; padding-bottom:40px; }
    h2 { color:#0d6efd; font-weight:700; }
    .section-card { background:white; border-radius:10px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.05); margin-bottom:18px; }
    .btn-report { background: linear-gradient(90deg,#198754,#0d6efd); color:white; border:none; }
    .small-muted { color:#6c757d; font-size:0.9rem; }
  </style>
</head>
<body class="container py-4">

  <div class="d-flex justify-content-between align-items-center my-3">
    <h2>üìä MongoDB Personnel Analytics</h2>
    <div>
      <button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#reportModal">‚¨áÔ∏è Download Report</button>
    </div>
  </div>

  <!-- Download Report Modal -->
  <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="{{ url_for('mongo_analytics.mongo_download_report') }}" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Download Analytics Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Company / Organization Name</label>
            <input name="company_name" class="form-control" placeholder="e.g. Acme Corp" />
          </div>
          <div class="mb-2">
            <label class="form-label">Company Details (address / contact)</label>
            <textarea name="company_details" class="form-control" rows="3" placeholder="Optional details for the report..."></textarea>
          </div>
          <p class="small-muted">PDF will include all visible analytics sections and generated timestamp.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-report">Generate & Download</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Company Blood Bank -->
  <div class="section-card mb-4">
    <h4>ü©∏ Company Blood Bank</h4>
    <div class="input-group my-2">
      <select id="bloodGroupSelect" class="form-select">
        <option value="">Select Blood Group</option>
        {% for b in blood_data %}
          {% if b._id %}
            <option value="{{ b._id }}">{{ b._id }} ({{ b.count }} employees)</option>
          {% endif %}
        {% endfor %}
      </select>
      <button class="btn btn-danger" onclick="fetchBloodGroupEmployees()">Search</button>
    </div>
    <div id="bloodResult" class="border rounded p-3 bg-light" style="display:none;">
      <h5>Employees with Selected Blood Group</h5>
      <ul id="bloodList" class="list-group"></ul>
    </div>
  </div>

  <!-- Qualification & Experience Per Employee -->
  <div class="section-card mb-4">
    <h4>üéì Qualifications & Past Experiences</h4>
    {% if qualification_data %}
      <div class="table-responsive">
        <table class="table table-bordered mb-0">
          <thead class="table-light">
            <tr>
              <th>Employee ID</th>
              <th>Name</th>
              <th>Qualification Count</th>
              <th>View Details</th>
            </tr>
          </thead>
          <tbody>
            {% for emp in qualification_data %}
            <tr>
              <td>{{ emp._id }}</td>
              <td>{{ emp.name or 'N/A' }}</td>
              <td>{{ emp.count }}</td>
              <td>
                <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ loop.index }}">Toggle</button>
                <div id="details-{{ loop.index }}" class="collapse mt-2">
                  <strong>Qualifications:</strong>
                  {% if emp.qualifications %}
                    <ul class="list-group mb-2">
                      {% for q in emp.qualifications %}<li class="list-group-item">{{ q }}</li>{% endfor %}
                    </ul>
                  {% else %}<p class="text-muted">No qualifications found.</p>{% endif %}
                  <strong>Past Experiences:</strong>
                  {% if emp.experiences %}
                    <ul class="list-group">
                      {% for e in emp.experiences %}<li class="list-group-item">{{ e }}</li>{% endfor %}
                    </ul>
                  {% else %}<p class="text-muted">No past experiences found.</p>{% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No qualification/experience data found.</p>
    {% endif %}
  </div>

  <!-- City-wise Count -->
  <div class="section-card mb-4">
    <h4>üèô City-wise Distribution</h4>
    {% if city_data %}
      <div class="table-responsive">
        <table class="table table-bordered mb-0">
          <thead class="table-light">
            <tr><th>City</th><th>Count</th></tr>
          </thead>
          <tbody>
            {% for city in city_data %}
            <tr><td>{{ city._id or "Unknown" }}</td><td>{{ city.count }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}<p class="text-muted">No city data available.</p>{% endif %}
  </div>

  <!-- State-wise Count -->
  <div class="section-card mb-4">
    <h4>üèû State-wise Distribution</h4>
    {% if state_data %}
      <div class="table-responsive">
        <table class="table table-bordered mb-0">
          <thead class="table-light"><tr><th>State</th><th>Count</th></tr></thead>
          <tbody>
            {% for state in state_data %}<tr><td>{{ state._id or "Unknown" }}</td><td>{{ state.count }}</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}<p class="text-muted">No state data available.</p>{% endif %}
  </div>

  <!-- Gender Distribution -->
  <div class="section-card mb-5">
    <h4>üöª Gender Distribution</h4>
    <div class="table-responsive">
      <table class="table table-bordered mb-0">
        <thead class="table-light"><tr><th>Gender</th><th>Count</th><th>Percentage</th></tr></thead>
        <tbody>
          <tr><td>Male</td><td>{{ gender_stats.male }}</td><td>{{ gender_stats.male_percent }}%</td></tr>
          <tr><td>Female</td><td>{{ gender_stats.female }}</td><td>{{ gender_stats.female_percent }}%</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="small-muted text-center">Analytics generated from personnel collection</p>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function fetchBloodGroupEmployees() {
      const group = document.getElementById("bloodGroupSelect").value;
      if (!group) { alert("Please select a blood group"); return; }

      fetch(`/personnel/analytics/bloodgroup/${group}`)
        .then(res => res.json())
        .then(data => {
          const resultDiv = document.getElementById("bloodResult");
          const list = document.getElementById("bloodList");
          list.innerHTML = "";

          if (data && data.length > 0) {
            data.forEach(emp => {
              const li = document.createElement("li");
              li.classList.add("list-group-item");
              li.innerHTML = `<strong>${emp.name}</strong> (ID: ${emp.employee_id})<br>üìû ${emp.phone || 'N/A'} | üìß ${emp.email || 'N/A'}`;
              list.appendChild(li);
            });
            resultDiv.style.display = "block";
          } else {
            list.innerHTML = `<li class="list-group-item text-muted">No employees found with this blood group.</li>`;
            resultDiv.style.display = "block";
          }
        })
        .catch(err => { console.error(err); alert("Error fetching blood group data."); });
    }
  </script>
</body>
</html>
