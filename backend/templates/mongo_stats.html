<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MongoDB Personnel Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

  <h2 class="mb-4">üìä MongoDB Personnel Analytics</h2>

  <!-- Company Blood Bank -->
  <div class="mb-5">
    <h4>ü©∏ Company Blood Bank</h4>
    <div class="input-group mb-3">
      <select id="bloodGroupSelect" class="form-select">
        <option value="">Select Blood Group</option>
        {% for b in blood_data %}
          {% if b._id %}
            <option value="{{ b._id }}">{{ b._id }} ({{ b.count }} employees)</option>
          {% endif %}
        {% endfor %}
      </select>
      <button class="btn btn-danger" onclick="fetchBloodGroupEmployees()">Search</button>
    </div>
    <div id="bloodResult" class="border rounded p-3 bg-light" style="display:none;">
      <h5>Employees with Selected Blood Group</h5>
      <ul id="bloodList" class="list-group"></ul>
    </div>
  </div>

  <!-- Qualification & Experience Per Employee -->
  <div class="mb-5">
    <h4>üéì Qualifications & Past Experiences</h4>
    {% if qualification_data %}
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Qualification Count</th>
            <th>View Details</th>
          </tr>
        </thead>
        <tbody>
          {% for emp in qualification_data %}
          <tr>
            <td>{{ emp._id }}</td>
            <td>{{ emp.name or 'N/A' }}</td>
            <td>{{ emp.count }}</td>
            <td>
              <button class="btn btn-sm btn-info" type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#details-{{ emp._id }}">
                Toggle
              </button>
              <div id="details-{{ emp._id }}" class="collapse mt-2">
                <strong>Qualifications:</strong>
                {% if emp.qualifications %}
                  <ul class="list-group mb-2">
                    {% for q in emp.qualifications %}
                      <li class="list-group-item">{{ q }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-muted">No qualifications found.</p>
                {% endif %}
                <strong>Past Experiences:</strong>
                {% if emp.experiences %}
                  <ul class="list-group">
                    {% for e in emp.experiences %}
                      <li class="list-group-item">{{ e }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-muted">No past experiences found.</p>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No qualification/experience data found.</p>
    {% endif %}
  </div>

  <!-- City-wise Count -->
  <div class="mb-5">
    <h4>üèô City-wise Distribution</h4>
    {% if city_data %}
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>City</th>
            <th>Count</th>
          </tr>
        </thead>
        <tbody>
          {% for city in city_data %}
          <tr>
            <td>{{ city._id or "Unknown" }}</td>
            <td>{{ city.count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No city data available.</p>
    {% endif %}
  </div>

  <!-- State-wise Count -->
  <div class="mb-5">
    <h4>üèû State-wise Distribution</h4>
    {% if state_data %}
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>State</th>
            <th>Count</th>
          </tr>
        </thead>
        <tbody>
          {% for state in state_data %}
          <tr>
            <td>{{ state._id or "Unknown" }}</td>
            <td>{{ state.count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">No state data available.</p>
    {% endif %}
  </div>

  <!-- Gender Distribution -->
  <div class="mb-5">
    <h4>üöª Gender Distribution</h4>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Gender</th>
          <th>Count</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Male</td>
          <td>{{ gender_stats.male }}</td>
          <td>{{ gender_stats.male_percent }}%</td>
        </tr>
        <tr>
          <td>Female</td>
          <td>{{ gender_stats.female }}</td>
          <td>{{ gender_stats.female_percent }}%</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function fetchBloodGroupEmployees() {
      const group = document.getElementById("bloodGroupSelect").value;
      if (!group) {
        alert("Please select a blood group");
        return;
      }

      fetch(`/personnel/analytics/bloodgroup/${group}`)
        .then(res => res.json())
        .then(data => {
          const resultDiv = document.getElementById("bloodResult");
          const list = document.getElementById("bloodList");
          list.innerHTML = "";

          if (data && data.length > 0) {
            data.forEach(emp => {
              const li = document.createElement("li");
              li.classList.add("list-group-item");
              li.innerHTML = `<strong>${emp.name}</strong> (ID: ${emp.employee_id})<br>
                              üìû ${emp.phone || 'N/A'} | üìß ${emp.email || 'N/A'}`;
              list.appendChild(li);
            });
            resultDiv.style.display = "block";
          } else {
            list.innerHTML = `<li class="list-group-item text-muted">No employees found with this blood group.</li>`;
            resultDiv.style.display = "block";
          }
        })
        .catch(err => {
          console.error(err);
          alert("Error fetching blood group data.");
        });
    }
  </script>
</body>
</html>
